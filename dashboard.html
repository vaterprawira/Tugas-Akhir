<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Electrical Load Optimization Simulator</title>
  <!-- Bootstrap CSS -->
  <link href="http://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom CSS -->
  <style>
    body {
      background-color: #f4f7fa;
      font-family: 'Arial', sans-serif;
    }
    .header {
      background: linear-gradient(90deg, #000000);
      padding: 1.5rem 0;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    .header-logo {
      height: 60px;
    }
    .navbar-nav .nav-link {
      color: #ffffff !important;
      font-size: 1.1rem;
      font-weight: 500;
      padding: 0.75rem 1.5rem;
      transition: all 0.3s ease;
      position: relative;
    }
    .navbar-nav .nav-link:hover {
      color: #d4e3ff !important;
      transform: translateY(-2px);
    }
    .navbar-nav .nav-link.active {
      color: #ffd700 !important;
      font-weight: 700;
    }
    .navbar-nav .nav-link.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 40%;
      height: 3px;
      background-color: #ffd700;
      border-radius: 2px;
    }
    .form-container {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-top: 1rem;
    }
    .nav-tabs .nav-link {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      margin-right: 0.5rem;
    }
    .nav-tabs .nav-link.active {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
    }
    .machine-list {
      margin-bottom: 1rem;
    }
    .machine-entry {
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      background-color: #f9f9f9;
    }
    .product-image {
      width: 100%;
      height: auto;
      max-width: 100%;
      max-height: 400px; /* Maximum size to prevent being too large */
      object-fit: contain; /* Ensures the image scales without distortion */
      margin-bottom: 1rem;
    }
    .btn-add-machine {
      background-color: #28a745;
      border: none;
      transition: background-color 0.3s;
      margin-bottom: 1rem;
    }
    .btn-add-machine:hover {
      background-color: #218838;
    }
    .btn-delete-machine {
      background-color: #dc3545;
      border: none;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      white-space: nowrap;
    }
    .btn-delete-machine:hover {
      background-color: #c82333;
    }
    .time-inputs {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .time-inputs .form-control {
      width: 100px;
      padding: 0.5rem 0.5rem;
      font-size: 0.875rem;
    }
    .operating-hours-label {
      margin-bottom: 0.5rem;
      display: block;
    }
    .btn-simulate, .btn-optimize {
      background-color: #007bff;
      border: none;
      padding: 0.75rem 2rem;
      font-size: 1.1rem;
    }
    .btn-simulate:hover, .btn-optimize:hover {
      background-color: #0056b3;
    }
    .result-section {
      margin-top: 2rem;
      padding: 2rem;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    .summary-table td {
      padding: 0.5rem;
      border-bottom: 1px solid #dee2e6;
    }
    .summary-table td:first-child {
      font-weight: bold;
      width: 50%;
    }
    .summary-subsection {
      margin-top: 1rem;
      margin-bottom: 1rem;
      padding-top: 0.5rem;
      border-top: 1px solid #eee; /* Separator for subsections */
    }
    .summary-subsection h6 {
      color: #6c757d;
      font-weight: bold;
      margin-bottom: 0.5rem;
      text-align: left;
    }
    .schedule-item {
      margin-bottom: 1rem;
      padding: 1rem;
      background-color: #f9f9f9;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .schedule-item h4 {
      font-size: 1.1rem;
      font-weight: bold;
      color: #4a90e2;
      margin-bottom: 0.5rem;
    }
    .machine-list-schedule {
      margin-top: 0.5rem;
      padding-left: 1rem;
      list-style-type: disc;
    }
    .footer {
      margin-top: 2rem;
      padding: 1rem;
      text-align: center;
      color: #6c757d;
    }
    #resultsPlot {
      max-width: 100%;
      height: auto;
    }
    @media (max-width: 768px) {
      .time-inputs {
        flex-direction: column;
        gap: 0.25rem;
      }
      .time-inputs .form-control {
        width: 100%;
      }
      .navbar-nav {
        margin-top: 1rem;
      }
      .navbar-nav .nav-link {
        padding: 0.5rem 1rem;
      }
    }
    .btn-delete-data {
      background-color: #dc3545;
      border: none;
      padding: 0.75rem 2rem;
      font-size: 1.1rem;
    }
    .btn-delete-data:hover {
      background-color: #c82333;
    }
    .optimization-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2rem;
      margin: 2rem 0;
    }
    .summary-section {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .summary-section h5 {
      color: #007bff;
      margin-bottom: 1rem;
      text-align: center;
      font-weight: bold;
    }
    .summary-table td {
      padding: 0.5rem;
      border-bottom: 1px solid #dee2e6;
    }
    .summary-table td:first-child {
      font-weight: 500;
      color: #495057;
    }
    @media (max-width: 992px) {
      .optimization-summary {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
    }
    .ga-params-form {
      display: none;
      margin-top: 1rem;
      padding: 1rem;
      background-color: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .ga-params-form label {
      font-weight: 500;
      margin-bottom: 0.5rem;
      display: block;
    }
    .ga-params-form .form-control {
      font-size: 0.875rem;
    }
    .btn-save-ga {
      background-color: #17a2b8;
      border: none;
      padding: 0.5rem 1.5rem;
      font-size: 1rem;
      margin-top: 1rem;
    }
    .btn-save-ga:hover {
      background-color: #138496;
    }
    /* New styles for schedule comparison */
    .schedule-comparison {
      display: grid;
      grid-template-columns: 1fr 1fr; /* Two columns for schedules */
      gap: 2rem; /* Space between columns */
      margin-top: 2rem;
    }
    .schedule-column {
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 1.5rem;
      background-color: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .schedule-column h5 {
      text-align: center;
      color: #007bff;
      margin-bottom: 1.5rem;
      font-weight: bold;
    }
    @media (max-width: 768px) {
      .schedule-comparison {
        grid-template-columns: 1fr; /* Stack columns on small screens */
        gap: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container-fluid">
      <div class="row align-items-center justify-content-between">
        <div class="col-md-4">
          <img src="logo_ukp.png" alt="Logo UKP" class="header-logo">
        </div>
        <div class="col-md-4 text-center">
          <nav class="navbar navbar-expand-lg justify-content-center">
            <div class="collapse navbar-collapse justify-content-center">
              <ul class="navbar-nav">
                <li class="nav-item">
                  <a class="nav-link" href="index.html">Home</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link active" href="dashboard.html">Dashboard</a>
                </li>
              </ul>
            </div>
          </nav>
        </div>
        <div class="col-md-4"></div>
      </div>
    </div>
  </header>

  <!-- Input Data Section -->
  <div class="container mt-5">
    <!-- Form Container -->
    <div class="form-container">
      <h3 class="mb-4">Input Data</h3>

      <!-- Tariff Selection -->
      <div class="mb-4">
        <label for="tariffSelect" class="form-label">Select Tariff Type:</label>
        <select class="form-select" id="tariffSelect" onchange="updateTariff()">
          <option value="withDemandCharge">With Demand Charge</option>
          <option value="noDemandCharge">No Demand Charge</option>
        </select>
      </div>

      <!-- Tariff Inputs (Dynamic) -->
      <div id="tariffInputs" class="mb-4">
        <h5 class="mb-3">Custom Tariff Details</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label for="offPeakRate" class="form-label">Off-Peak Rate ($/kWh)</label>
            <input type="number" class="form-control" id="offPeakRate" step="0.001" min="0" placeholder="e.g., 0.064" required>
          </div>
          <div class="col-md-6">
            <label for="onPeakRate" class="form-label">On-Peak Rate ($/kWh)</label>
            <input type="number" class="form-control" id="onPeakRate" step="0.001" min="0" placeholder="e.g., 0.0896" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Peak Period</label>
            <div class="time-inputs">
              <input type="time" class="form-control" id="peakPeriodStartHour" required>
              <input type="time" class="form-control" id="peakPeriodEndHour" required>
            </div>
          </div>
          <div class="col-md-12" id="demandChargeInputGroup">
            <label for="demandChargeInput" class="form-label">Demand Charge ($/kW)</label>
            <input type="number" class="form-control" id="demandChargeInput" step="0.01" min="0" required>
          </div>
        </div>
      </div>

      <!-- Product Selection -->
      <div class="mb-4">
        <label for="productSelect" class="form-label">Select Product:</label>
        <select class="form-select" id="productSelect" onchange="updateProduct()">
          <option value="waferCream">Wafer Cream</option>
          <option value="waferStick">Wafer Stick</option>
        </select>
      </div>

      <!-- Product Image -->
      <div class="mb-4">
        <img id="productImage" src="flow_diagram_wafercream.png" alt="Product Image" class="product-image" onload="console.log('Image loaded:', this.src)" onerror="console.error('Image failed to load:', this.src)">
      </div>

      <!-- Navigation Tabs -->
      <ul class="nav nav-tabs mb-3" id="processTabs" role="tablist"></ul>

      <!-- Tab Content -->
      <div class="tab-content" id="processTabContent"></div>

      <!-- Simulation Selection for Optimization -->
      <div class="mb-4">
        <label for="simulationSelect" class="form-label">Select Simulation:</label>
        <select class="form-select" id="simulationSelect" onchange="handleSimulationSelect()">
          <option value="">Select a simulation</option>
        </select>
      </div>
      <div class="ga-params-form" id="gaParamsForm">
        <h5 class="mb-3">Genetic Algorithm Parameters</h5>
        <div class="row g-3">
          <div class="col-md-4">
            <label for="populationSize">Population Size (min: 10)</label>
            <input type="number" class="form-control" id="populationSize" min="10" placeholder="Default: 300" required>
          </div>
          <div class="col-md-4">
            <label for="crossoverRate">Crossover Rate (0 to 1)</label>
            <input type="number" class="form-control" id="crossoverRate" step="0.01" min="0" max="1" placeholder="Default: 0.8" required>
          </div>
          <div class="col-md-4">
            <label for="mutationRate">Mutation Rate (0 to 1)</label>
            <input type="number" class="form-control" id="mutationRate" step="0.01" min="0" max="1" placeholder="Default: 0.2" required>
          </div>
          <div class="col-md-4">
            <label for="tournamentSize">Tournament Size (min: 2)</label> 
            <input type="number" class="form-control" id="tournamentSize" min="2" placeholder="Default: 3" required>
          </div>
          <div class="col-md-4">
            <label for="elitismRate">Elitism Rate (0 to 0.5)</label>
            <input type="number" class="form-control" id="elitismRate" step="0.01" min="0" max="0.5" placeholder="Default: 0.05" required>
          </div>
        </div>
        <button class="btn btn-save-ga" onclick="saveGaParameters()">Save GA Parameters</button>
      </div>

      <!-- Buttons -->
      <div class="text-center mt-4">
        <button class="btn btn-delete-data me-2" onclick="deleteSimulation()">Delete Data</button>
        <button class="btn btn-simulate me-2" onclick="simulateLoad()">Save Data</button>
        <button class="btn btn-optimize" onclick="runOptimization()">Run Optimization</button>
      </div>
    </div>

    <!-- Result Section -->
    <div class="result-section" id="result-section" style="display: none;">
      <h3>Optimisation Results</h3>

      <!-- Visualization -->
      <h4 class="mb-3">Load Profile Results</h4>
      <img id="resultsPlot" src="" alt="Optimization Results Plot">

      <!-- Optimization Results Summary -->
      <h4 class="mb-3 mt-4">Optimisation Results Summary</h4>
      <div class="optimization-summary">
        <div class="summary-section">
          <h5>Before Optimisation</h5>
          <table class="summary-table">
            <tr><td>Peak Load:</td><td id="originalPeakLoad"></td></tr> <!-- Peak Load is standalone -->
          </table>
          <div class="summary-subsection">
            <h6>Daily Metrics</h6>
            <table class="summary-table">
              <tr><td>Total Energy:</td><td id="originalTotalDailyEnergy"></td></tr>
              <tr><td>Demand Cost:</td><td id="originalDemandCostDaily"></td></tr>
              <tr><td>Energy Cost:</td><td id="originalEnergyCostDaily"></td></tr>
              <tr><td>Total Cost:</td><td id="originalTotalCostDaily"></td></tr>
            </table>
          </div>
          <div class="summary-subsection">
            <h6>Monthly Metrics</h6>
            <table class="summary-table">
              <tr><td>Total Energy:</td><td id="originalTotalMonthlyEnergy"></td></tr>
              <tr><td>Demand Cost:</td><td id="originalDemandCostMonthly"></td></tr>
              <tr><td>Energy Cost:</td><td id="originalEnergyCostMonthly"></td></tr>
              <tr><td>Total Cost:</td><td id="originalTotalCostMonthly"></td></tr>
            </table>
          </div>
        </div>
        
        <div class="summary-section">
          <h5>After Optimisation</h5>
          <table class="summary-table">
            <tr><td>Peak Load:</td><td id="optimizedPeakLoad"></td></tr> <!-- Peak Load is standalone -->
          </table>
          <div class="summary-subsection">
            <h6>Daily Metrics</h6>
            <table class="summary-table">
              <tr><td>Total Energy:</td><td id="optimizedTotalDailyEnergy"></td></tr>
              <tr><td>Demand Cost:</td><td id="optimizedDemandCostDaily"></td></tr>
              <tr><td>Energy Cost:</td><td id="optimizedEnergyCostDaily"></td></tr>
              <tr><td>Total Cost:</td><td id="optimizedTotalCostDaily"></td></tr>
            </table>
          </div>
          <div class="summary-subsection">
            <h6>Monthly Metrics</h6>
            <table class="summary-table">
              <tr><td>Total Energy:</td><td id="optimizedTotalMonthlyEnergy"></td></tr>
              <tr><td>Demand Cost:</td><td id="optimizedDemandCostMonthly"></td></tr>
              <tr><td>Energy Cost:</td><td id="optimizedEnergyCostMonthly"></td></tr>
              <tr><td>Total Cost:</td><td id="optimizedTotalCostMonthly"></td></tr>
            </table>
          </div>
        </div>
        
        <div class="summary-section">
          <h5>Savings</h5>
          <table class="summary-table">
            <tr><td>Peak Reduction:</td><td id="peakReduction"></td></tr>
          </table>
          <div class="summary-subsection">
            <h6>Daily Savings</h6>
            <table class="summary-table">
              <tr><td>Demand Cost:</td><td id="demandCostDailySavings"></td></tr>
              <tr><td>Energy Cost:</td><td id="energyCostDailySavings"></td></tr>
              <tr><td>Total Cost:</td><td id="totalCostDailySavings"></td></tr>
            </table>
          </div>
          <div class="summary-subsection">
            <h6>Monthly Savings</h6>
            <table class="summary-table">
              <tr><td>Demand Cost:</td><td id="demandCostMonthlySavings"></td></tr>
              <tr><td>Energy Cost:</td><td id="energyCostMonthlySavings"></td></tr>
              <tr><td>Total Cost:</td><td id="totalCostMonthlySavings"></td></tr>
            </table>
          </div>
        </div>
      </div>

      <!-- Production Schedule -->
      <h4 class="mt-4 mb-3">Production Schedule</h4>
      <div class="schedule-comparison">
        <div class="schedule-column">
          <h5>Before Optimisation</h5>
          <div id="originalSchedule"></div>
        </div>
        <div class="schedule-column">
          <h5>After Optimisation</h5>
          <div id="optimizedSchedule"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <p>© 2025 Petra Christian University - Final Project</p>
  </div>

  <!-- Bootstrap JS -->
  <script src="http://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let machineData = {
      waferCream: {},
      waferStick: {}
    };
    let machineCounts = {
      waferCream: {},
      waferStick: {}
    };
    let currentProduct = 'waferCream';
    let currentTariff = 'withDemandCharge';
    let currentSimulationId = null;

    const stepNames = {
      // Keys are camelCase to match the product selection values directly
      waferCream: [ 
        'Batter Preparation',
        'Baking',
        'Cooling Sheet and Conditioning',
        'Spreading and Stacking',
        'Sandwich Cooling',
        'Cutting',
        'Enrobing',
        'Packaging'
      ],
      waferStick: [
        'Batter Preparation',
        'Wafer Stick',
        'Packaging'
      ]
    };

    const productImages = {
      'waferCream': 'flow_diagram_wafercream.png',
      'waferStick': 'flow_diagram_waferstick.png'
    };

    function initializeTabs(product) {
      const tabList = document.getElementById('processTabs');
      const tabContent = document.getElementById('processTabContent');
      tabList.innerHTML = '';
      tabContent.innerHTML = '';
      const processCount = product === 'waferCream' ? 8 : 3;

      machineCounts[product] = machineCounts[product] || {};
      for (let i = 1; i <= processCount; i++) {
        // Ensure machineData[product][i] exists and has at least one empty machine if not present
        if (!machineData[product][i] || machineData[product][i].length === 0) {
          machineData[product][i] = [{
            name: '',
            quantity: '',
            power: '',
            startTime: '',
            endTime: ''
          }];
        }

        machineCounts[product][i] = machineData[product][i].length;

        const tabId = `step-tab-${i}`;
        const paneId = `step-${i}`;
        const isActive = i === 1;
        const stepName = stepNames[product][i - 1];

        const tab = document.createElement('li');
        tab.className = 'nav-item';
        tab.setAttribute('role', 'presentation');
        tab.innerHTML = `
          <button class="nav-link ${isActive ? 'active' : ''}" id="${tabId}" data-bs-toggle="tab" data-bs-target="#${paneId}" type="button" role="tab" aria-controls="${paneId}" aria-selected="${isActive}">${stepName}</button>
        `;
        tabList.appendChild(tab);

        const pane = document.createElement('div');
        pane.className = `tab-pane fade ${isActive ? 'show active' : ''}`;
        pane.id = paneId;
        pane.setAttribute('role', 'tabpanel');
        pane.setAttribute('aria-labelledby', tabId);

        const machineList = document.createElement('div');
        machineList.className = 'machine-list';
        machineList.id = `machine-list-${i}`;

        machineData[product][i].forEach((machine, index) => {
          const machineIndex = index + 1;
          const machineEntry = document.createElement('div');
          machineEntry.className = 'machine-entry';
          machineEntry.id = `machine-${i}-${machineIndex}`;
          machineEntry.innerHTML = `
            <div class="row g-3 align-items-end mt-3">
              <div class="col-md-3">
                <label for="machine-name-${i}-${machineIndex}" class="form-label">Machine Name</label>
                <input type="text" class="form-control" id="machine-name-${i}-${machineIndex}" placeholder="e.g., Mixer" required value="${machine.name || ''}">
              </div>
              <div class="col-md-2">
                <label for="quantity-${i}-${machineIndex}" class="form-label">Number of Machines</label>
                <input type="number" class="form-control" id="quantity-${i}-${machineIndex}" placeholder="e.g., 5" min="1" required value="${machine.quantity || ''}">
              </div>
              <div class="col-md-2">
                <label for="power-${i}-${machineIndex}" class="form-label">Power (kW)</label>
                <input type="number" class="form-control" id="power-${i}-${machineIndex}" placeholder="e.g., 2.2" step="0.1" min="0" required value="${machine.power || ''}">
              </div>
              <div class="col-md-2">
                <label class="operating-hours-label">Operating Hours</label>
                <div class="time-inputs">
                  <input type="time" class="form-control" id="start-time-${i}-${machineIndex}" required value="${machine.startTime || ''}">
                  <input type="time" class="form-control" id="end-time-${i}-${machineIndex}" required value="${machine.endTime || ''}">
                </div>
              </div>
              <div class="col-md-1 d-flex align-items-end">
                <button class="btn btn-delete-machine" onclick="deleteMachineEntry(${i}, ${machineIndex})" style="${machineCounts[product][i] === 1 ? 'display: none;' : ''}">Delete</button>
              </div>
            </div>
          `;
          machineList.appendChild(machineEntry);

          setTimeout(() => addInputListeners(i, machineIndex), 0);
        });

        pane.appendChild(machineList);
        pane.innerHTML += `
          <button class="btn btn-add-machine" onclick="addMachineEntry(${i})">Add Another Machine</button>
        `;
        tabContent.appendChild(pane);
      }
    }

    function addMachineEntry(step) {
      const product = currentProduct;
      machineCounts[product][step]++;
      const machineIndex = machineCounts[product][step];
      const machineList = document.getElementById(`machine-list-${step}`);
      const newEntry = document.createElement('div');
      newEntry.className = 'machine-entry';
      newEntry.id = `machine-${step}-${machineIndex}`;
      newEntry.innerHTML = `
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label for="machine-name-${step}-${machineIndex}" class="form-label">Machine Name</label>
            <input type="text" class="form-control" id="machine-name-${step}-${machineIndex}" placeholder="e.g., Mixer" required>
          </div>
          <div class="col-md-2">
            <label for="quantity-${step}-${machineIndex}" class="form-label">Number of Machines</label>
            <input type="number" class="form-control" id="quantity-${step}-${machineIndex}" placeholder="e.g., 5" min="1" required>
          </div>
          <div class="col-md-2">
            <label for="power-${step}-${machineIndex}" class="form-label">Power (kW)</label>
            <input type="number" class="form-control" id="power-${step}-${machineIndex}" placeholder="e.g., 2.2" step="0.1" min="0" required>
          </div>
          <div class="col-md-2">
            <label class="operating-hours-label">Operating Hours</label>
            <div class="time-inputs">
              <input type="time" class="form-control" id="start-time-${step}-${machineIndex}" required>
              <input type="time" class="form-control" id="end-time-${step}-${machineIndex}" required>
            </div>
          </div>
          <div class="col-md-1 d-flex align-items-end">
            <button class="btn btn-delete-machine" onclick="deleteMachineEntry(${step}, ${machineIndex})">Delete</button>
          </div>
        </div>
      `;
      machineList.appendChild(newEntry);

      machineData[product][step].push({
        name: '',
        quantity: '',
        power: '',
        startTime: '',
        endTime: ''
      });

      // Show all delete buttons if there's more than one machine entry for this step
      if (machineCounts[product][step] > 1) {
        document.querySelectorAll(`#machine-list-${step} .btn-delete-machine`).forEach(btn => {
          btn.style.display = 'block';
        });
      }

      setTimeout(() => addInputListeners(step, machineIndex), 0);
    }

    function deleteMachineEntry(step, index) {
      const product = currentProduct;
      const entry = document.getElementById(`machine-${step}-${index}`);
      if (entry) {
        entry.remove();
        machineCounts[product][step]--;
        // Remove the machine data from the array
        machineData[product][step].splice(index - 1, 1);

        // Re-index remaining machines visually and in data if necessary (optional but good practice)
        // For simplicity, we just update the counts and hide/show delete button for the first item
        
        // If only one machine remains, hide its delete button
        if (machineCounts[product][step] === 1) {
          const firstDeleteButton = document.querySelector(`#machine-list-${step} .btn-delete-machine`);
          if (firstDeleteButton) {
            firstDeleteButton.style.display = 'none';
          }
        }
      }
    }

    function addInputListeners(step, index) {
      ['machine-name', 'quantity', 'power', 'start-time', 'end-time'].forEach(field => {
        const input = document.getElementById(`${field}-${step}-${index}`);
        if (input) {
          input.addEventListener('input', () => {
            updateData(step, index);
          });
        }
      });
    }

    function updateData(step, index) {
      const product = currentProduct;
      const machine = {
        name: document.getElementById(`machine-name-${step}-${index}`).value,
        quantity: document.getElementById(`quantity-${step}-${index}`).value,
        power: document.getElementById(`power-${step}-${index}`).value,
        startTime: document.getElementById(`start-time-${step}-${index}`).value,
        endTime: document.getElementById(`end-time-${step}-${index}`).value
      };

      // Only update if the machineData for this step and index exists (it should, due to push in addMachineEntry)
      if (machineData[product][step][index - 1]) {
        machineData[product][step][index - 1] = machine;
      } else {
        console.warn(`Attempted to update non-existent machineData at step ${step}, index ${index}`);
      }
    }

    function updateProduct() {
      currentProduct = document.getElementById('productSelect').value;
      const imageUrl = productImages[currentProduct];
      const productImage = document.getElementById('productImage');
      productImage.src = imageUrl;
      productImage.alt = currentProduct === 'waferCream' ? 'Wafer Cream' : 'Wafer Stick';
      console.log('Setting image to:', imageUrl); // Debugging log
      initializeTabs(currentProduct);
    }

    function updateTariff() {
      currentTariff = document.getElementById('tariffSelect').value;
      console.log('Tariff updated to:', currentTariff);
      toggleDemandChargeInput(); // Call this function to update visibility
    }

    function toggleDemandChargeInput() {
      const tariffSelect = document.getElementById('tariffSelect');
      const demandChargeInputGroup = document.getElementById('demandChargeInputGroup');
      const demandChargeInput = document.getElementById('demandChargeInput');

      if (tariffSelect.value === 'withDemandCharge') {
        demandChargeInputGroup.style.display = 'block';
        demandChargeInput.setAttribute('required', 'true');
        demandChargeInput.placeholder = 'e.g., 10.00'; 
      } else {
        demandChargeInputGroup.style.display = 'none';
        demandChargeInput.removeAttribute('required');
        demandChargeInput.value = '0'; 
      }
    }


    function fetchSimulations() {
      console.log('Fetching simulations...');
      fetch('http://203.189.121.130:5000/api/simulations')
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.json();
        })
        .then(simulations => {
          const select = document.getElementById('simulationSelect');
          select.innerHTML = '<option value="">Select a simulation</option>';
          // Sort simulations by created_at in descending order (assuming it's available)
          simulations.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

          simulations.forEach(sim => {
            const option = document.createElement('option');
            option.value = sim.simulation_id;
            const date = new Date(sim.created_at).toLocaleString();
            option.textContent = `Simulation ${sim.simulation_id}: ${sim.tariff_type}`;
            select.appendChild(option);
          });
          console.log('Simulations loaded:', simulations);
        })
        .catch(error => {
          console.error('Error fetching simulations:', error);
          // Use a custom alert message instead of browser's default
          displayCustomAlert('Failed to load simulations: ' + error.message, 'danger');
        });
    }

    function simulateLoad() {
      currentTariff = document.getElementById('tariffSelect').value;
      console.log('Simulate load with tariff:', currentTariff);

      // Validate tariff inputs before proceeding
      if (!validateTariffInputs()) {
          return; // Stop if validation fails
      }

      function getProcesses(productKey) {
        const processCount = productKey === 'waferCream' ? 8 : 3;
        const processes = [];
        for (let i = 1; i <= processCount; i++) {
          const machines = machineData[productKey][i]
            .map((machine, index) => ({
              machine_name: machine.name,
              quantity: parseInt(machine.quantity),
              power: parseFloat(machine.power),
              // Ensure time formats are 'HH:MM:SS' for backend
              start_time: machine.startTime ? machine.startTime + ':00' : '',
              stop_time: machine.endTime ? machine.endTime + ':00' : ''
            }))
            // Filter out incomplete or invalid machine entries
            .filter(machine => 
                machine.machine_name && machine.machine_name.trim() !== '' &&
                !isNaN(machine.quantity) && machine.quantity > 0 && 
                !isNaN(machine.power) && machine.power >= 0 && 
                machine.start_time && machine.start_time.trim() !== '' &&
                machine.stop_time && machine.stop_time.trim() !== ''
            );

          if (machines.length > 0) {
            processes.push({
              process_name: stepNames[productKey][i - 1], // Use the correct step name
              machines
            });
          }
        }
        return processes;
      }

      const waferCreamProcesses = getProcesses('waferCream');
      const waferStickProcesses = getProcesses('waferStick');

      const products = [];
      if (waferCreamProcesses.length > 0) {
          products.push({ product: 'Wafer Cream', processes: waferCreamProcesses });
      }
      if (waferStickProcesses.length > 0) {
          products.push({ product: 'Wafer Stick', processes: waferStickProcesses });
      }

      if (products.length === 0) {
        displayCustomAlert('Please add at least one valid process with machines for Wafer Cream or Wafer Stick.', 'warning');
        return;
      }

      // Collect custom tariff details
      const tariffParams = {
          offPeakRate: document.getElementById('offPeakRate').value,
          onPeakRate: document.getElementById('onPeakRate').value,
          peakPeriodStartHour: document.getElementById('peakPeriodStartHour').value, // HH:MM string
          peakPeriodEndHour: document.getElementById('peakPeriodEndHour').value,     // HH:MM string
          demandChargeInput: document.getElementById('demandChargeInput').value 
      };


      const payload = {
        products,
        tariff: currentTariff === 'withDemandCharge' ? 'With Demand Charge' : 'No Demand Charge',
        tariff_params: tariffParams // Include custom tariff details in payload
      };
      console.log('Sending payload to /api/insert_data:', JSON.stringify(payload));

      // Disable buttons during API call
      setLoadingButtons(true);

      fetch('http://203.189.121.130:5000/api/insert_data', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
      })
        .then(response => {
          if (!response.ok) {
            // Attempt to parse error message from backend
            return response.json().then(err => { throw new Error(err.error || `HTTP error! status: ${response.status}`); });
          }
          return response.json();
        })
        .then(data => {
          if (data.message) {
            currentSimulationId = data.simulation_id;
            displayCustomAlert(data.message, 'success');
            fetchSimulations(); // Refresh simulation list
            // Automatically select the newly created simulation
            document.getElementById('simulationSelect').value = currentSimulationId;
            handleSimulationSelect(); // Trigger GA params form display
          } else {
            displayCustomAlert('Error: ' + (data.error || 'Unknown error'), 'danger');
          }
        })
        .catch(error => {
          console.error('Error saving data:', error);
          displayCustomAlert('An error occurred while saving data: ' + error.message, 'danger');
        })
        .finally(() => {
            setLoadingButtons(false); // Re-enable buttons
        });
    }

    // New function to render a generic schedule list (used for both original and optimized)
    function renderScheduleList(elementId, scheduleList) {
      const scheduleDiv = document.getElementById(elementId);
      if (!scheduleDiv) return; // Exit if element not found

      // Helper function to convert "Wafer Cream" to "waferCream"
      function toCamelCaseKey(str) {
        return str.split(' ').map((word, index) => {
          if (index === 0) return word.toLowerCase();
          return word.charAt(0).toUpperCase() + word.slice(1);
        }).join('');
      }

      // Sort the scheduleList by process name based on stepNames order for consistent display
      const sortedScheduleList = [...scheduleList].sort((a, b) => {
        const productA_raw = a.process_name.split(' - ')[0]; // e.g., "Wafer Cream"
        const stepA = a.process_name.split(' - ')[1];       // e.g., "Batter Preparation"
        const productB_raw = b.process_name.split(' - ')[0]; // e.g., "Wafer Stick"
        const stepB = b.process_name.split(' - ')[1];       // e.g., "Wafer Stick"

        // Correctly get the camelCase key for product names
        const productA_key = toCamelCaseKey(productA_raw); 
        const productB_key = toCamelCaseKey(productB_raw);

        // Safely get the order lists from stepNames using the correct camelCase keys
        const orderListA = stepNames[productA_key];
        const orderListB = stepNames[productB_key];

        // Safely get the index, defaulting to a large number if not found or list is null/undefined
        const orderA = orderListA ? orderListA.indexOf(stepA) : 9999;
        const orderB = orderListB ? orderListB.indexOf(stepB) : 9999;

        if (productA_key === productB_key) {
            return orderA - orderB;
        }
        return productA_key.localeCompare(productB_key); // Sort by product name if different
      });

      scheduleDiv.innerHTML = sortedScheduleList.map(process => `
        <div class="schedule-item">
          <h4>${process.process_name}</h4>
          <p><strong>Machines:</strong></p>
          <ul class="machine-list-schedule">
            ${process.machines.map(machine => `
              <li>
                ${machine.machine_name}
                (Qty: ${machine.quantity}, Power: ${machine.power} kW) <br>
                <strong>Start:</strong> ${machine.start_time},
                <strong>End:</strong> ${machine.end_time}
              </li>
            `).join('')}
          </ul>
        </div>
      `).join('');
    }


    function setLoadingButtons(isLoading) {
      const saveBtn = document.querySelector('.btn-simulate');
      const optimizeBtn = document.querySelector('.btn-optimize');
      const deleteBtn = document.querySelector('.btn-delete-data');
      const saveGaBtn = document.querySelector('.btn-save-ga');

      if (saveBtn) {
        saveBtn.disabled = isLoading;
        saveBtn.textContent = isLoading ? 'Saving...' : 'Save Data';
      }
      if (optimizeBtn) {
        optimizeBtn.disabled = isLoading;
        optimizeBtn.textContent = isLoading ? 'Optimizing...' : 'Run Optimization';
      }
      if (deleteBtn) {
        deleteBtn.disabled = isLoading;
      }
      if (saveGaBtn) {
        saveGaBtn.disabled = isLoading;
      }
      // Also disable inputs during loading, if desired, but not strictly necessary for this logic
    }

    async function runOptimization() {
      currentTariff = document.getElementById('tariffSelect').value; // Ensure currentTariff is up-to-date
      console.log('Run optimization with tariff:', currentTariff);

      setLoadingButtons(true); // Disable all relevant buttons

      try {
        const simulationId = document.getElementById('simulationSelect').value;
        const tariffType = currentTariff === 'withDemandCharge' ? 'With Demand Charge' : 'No Demand Charge';

        if (!simulationId) {
          displayCustomAlert('Please select a simulation.', 'warning');
          setLoadingButtons(false);
          return;
        }

        // Validate tariff inputs before sending to backend for optimization (critical)
        if (!validateTariffInputs()) {
            setLoadingButtons(false);
            return; // Stop if validation fails
        }
        
        // Collect custom tariff details for sending to backend
        const tariffParams = {
            offPeakRate: document.getElementById('offPeakRate').value,
            onPeakRate: document.getElementById('onPeakRate').value,
            peakPeriodStartHour: document.getElementById('peakPeriodStartHour').value, // HH:MM string
            peakPeriodEndHour: document.getElementById('peakPeriodEndHour').value,     // HH:MM string
            demandChargeInput: document.getElementById('demandChargeInput').value 
        };

        const payload = { 
            simulation_id: parseInt(simulationId), 
            tariff_type: tariffType,
            tariff_params: tariffParams // Include custom tariff details in payload
        };
        console.log('Sending payload to /api/run_optimization:', JSON.stringify(payload));

        const response = await fetch('http://203.189.121.130:5000/api/run_optimization', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Server error during optimization.');
        }

        const result = await response.json();
        if (result.error) {
          throw new Error(result.error);
        }

        // Update summary table
        document.getElementById('originalPeakLoad').textContent = `${result.summary.original_peak_load} kW`;
        document.getElementById('optimizedPeakLoad').textContent = `${result.summary.optimized_peak_load} kW`;
        
        // Daily Metrics
        document.getElementById('originalTotalDailyEnergy').textContent = `${result.summary.original_total_daily_energy} kWh`;
        document.getElementById('originalDemandCostDaily').textContent = `$${result.summary.original_demand_cost_daily.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('originalEnergyCostDaily').textContent = `$${result.summary.original_energy_cost_daily.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('originalTotalCostDaily').textContent = `$${result.summary.original_total_cost_daily.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

        document.getElementById('optimizedTotalDailyEnergy').textContent = `${result.summary.optimized_total_daily_energy} kWh`;
        document.getElementById('optimizedDemandCostDaily').textContent = `$${result.summary.optimized_demand_cost_daily.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('optimizedEnergyCostDaily').textContent = `$${result.summary.optimized_energy_cost_daily.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('optimizedTotalCostDaily').textContent = `$${result.summary.optimized_total_cost_daily.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

        // Monthly Metrics
        document.getElementById('originalTotalMonthlyEnergy').textContent = `${result.summary.original_total_monthly_energy} kWh`;
        document.getElementById('originalDemandCostMonthly').textContent = `$${result.summary.original_demand_cost_monthly.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('originalEnergyCostMonthly').textContent = `$${result.summary.original_energy_cost_monthly.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('originalTotalCostMonthly').textContent = `$${result.summary.original_total_cost_monthly.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

        document.getElementById('optimizedTotalMonthlyEnergy').textContent = `${result.summary.optimized_total_monthly_energy} kWh`;
        document.getElementById('optimizedDemandCostMonthly').textContent = `$${result.summary.optimized_demand_cost_monthly.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('optimizedEnergyCostMonthly').textContent = `$${result.summary.optimized_energy_cost_monthly.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('optimizedTotalCostMonthly').textContent = `$${result.summary.optimized_total_cost_monthly.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;


        // Savings
        document.getElementById('peakReduction').textContent = `${result.summary.peak_reduction} kW (${result.summary.peak_reduction_percent.toFixed(2)}%)`;
        
        // Daily Savings
        document.getElementById('demandCostDailySavings').textContent = `$${result.summary.demand_cost_daily_savings.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${result.summary.demand_cost_daily_savings_percent.toFixed(2)}%)`;
        document.getElementById('energyCostDailySavings').textContent = `$${result.summary.energy_cost_daily_savings.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${result.summary.energy_cost_daily_savings_percent.toFixed(2)}%)`;
        document.getElementById('totalCostDailySavings').textContent = `$${result.summary.total_cost_daily_savings.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${result.summary.total_cost_daily_savings_percent.toFixed(2)}%)`;

        // Monthly Savings
        document.getElementById('demandCostMonthlySavings').textContent = `$${result.summary.demand_cost_monthly_savings.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${result.summary.demand_cost_monthly_savings_percent.toFixed(2)}%)`;
        document.getElementById('energyCostMonthlySavings').textContent = `$${result.summary.energy_cost_monthly_savings.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${result.summary.energy_cost_monthly_savings_percent.toFixed(2)}%)`;
        document.getElementById('totalCostMonthlySavings').textContent = `$${result.summary.total_cost_monthly_savings.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${result.summary.total_cost_monthly_savings_percent.toFixed(2)}%)`;

        // Render both original and optimized schedules
        renderScheduleList('originalSchedule', result.schedule.original_schedule);
        renderScheduleList('optimizedSchedule', result.schedule.optimized_schedule);

        document.getElementById('resultsPlot').src = result.visualization.results_plot;

        document.getElementById('result-section').style.display = 'block';

      } catch (error) {
        console.error('Error during optimization:', error);
        displayCustomAlert('An error occurred during optimization: ' + error.message, 'danger');
      } finally {
        setLoadingButtons(false); // Re-enable buttons
      }
    }

    function deleteSimulation() {
      const simulationId = document.getElementById('simulationSelect').value;
      if (!simulationId) {
        displayCustomAlert('Please select a simulation to delete.', 'warning');
        return;
      }

      // Use a custom confirmation dialog or modal instead of browser's default alert/confirm
      if (!confirm('Are you sure you want to delete this simulation? This action cannot be undone.')) {
        return;
      }

      setLoadingButtons(true);

      fetch(`http://203.189.121.130:5000/api/delete_data`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ simulation_id: parseInt(simulationId) })
      })
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || `HTTP error! status: ${response.status}`); });
          }
          return response.json();
        })
        .then(data => {
          if (data.message) {
            displayCustomAlert(data.message, 'success');
            fetchSimulations(); // Refresh simulation list
            document.getElementById('result-section').style.display = 'none'; // Hide results
            handleSimulationSelect(); // Reset GA params form and button state
          } else {
            displayCustomAlert('Error: ' + (data.error || 'Unknown error'), 'danger');
          }
        })
        .catch(error => {
          console.error('Failed to delete simulation:', error);
          displayCustomAlert('An error occurred while deleting simulation: ' + error.message, 'danger');
        })
        .finally(() => {
          setLoadingButtons(false);
        });
    }

    function handleSimulationSelect() {
      const simulationId = document.getElementById('simulationSelect').value;
      const gaParamsForm = document.getElementById('gaParamsForm');
      const runOptimizationBtn = document.querySelector('.btn-optimize');
      
      if (simulationId) {
        gaParamsForm.style.display = 'block';
        runOptimizationBtn.disabled = false; // Enable run optimization button by default if simulation selected
        
        // Fetch and populate custom tariff details from DB for the selected simulation
        fetch(`http://203.189.121.130:5000/api/simulations/${simulationId}/tariff_details`)
            .then(response => {
                if (!response.ok && response.status !== 404) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data && !data.error) {
                    document.getElementById('offPeakRate').value = data.lwbp_rate;
                    document.getElementById('onPeakRate').value = data.wbp_rate;
                    document.getElementById('peakPeriodStartHour').value = data.peak_start_hour; // HH:MM
                    document.getElementById('peakPeriodEndHour').value = data.peak_end_hour; // HH:MM
                    document.getElementById('demandChargeInput').value = data.demand_charge;
                    // Also update the tariff select if the fetched data implies a different tariff type
                    document.getElementById('tariffSelect').value = data.tariff_type.includes("Demand") ? "withDemandCharge" : "noDemandCharge";
                    toggleDemandChargeInput(); // Ensure visibility is correct after populating
                } else {
                    // If no custom tariff details found, reset to empty fields/default logic
                    document.getElementById('offPeakRate').value = '';
                    document.getElementById('onPeakRate').value = '';
                    document.getElementById('peakPeriodStartHour').value = '';
                    document.getElementById('peakPeriodEndHour').value = '';
                    document.getElementById('demandChargeInput').value = '';
                    // Set default tariff type in select if no custom tariff saved
                    document.getElementById('tariffSelect').value = "withDemandCharge"; 
                    toggleDemandChargeInput(); // Ensure visibility is correct after reset
                }
            })
            .catch(error => {
                console.error('Error fetching custom tariff details:', error);
                displayCustomAlert('Failed to load custom tariff details: ' + error.message, 'danger');
            });

        fetchGaParameters(simulationId); // Fetch GA parameters as before
      } else {
        gaParamsForm.style.display = 'none';
        resetGaParamsForm();
        runOptimizationBtn.disabled = true; // Disable if no simulation selected
        // Clear tariff inputs when no simulation is selected
        document.getElementById('offPeakRate').value = '';
        document.getElementById('onPeakRate').value = '';
        document.getElementById('peakPeriodStartHour').value = '';
        document.getElementById('peakPeriodEndHour').value = '';
        document.getElementById('demandChargeInput').value = '';
        document.getElementById('tariffSelect').value = "withDemandCharge"; // Reset tariff type
        toggleDemandChargeInput();
      }
    }

    function fetchGaParameters(simulationId) {
      fetch(`http://203.189.121.130:5000/api/ga_parameters/${simulationId}`)
        .then(response => {
          if (!response.ok && response.status !== 404) throw new Error(`HTTP error! status: ${response.status}`);
          return response.status === 404 ? {} : response.json(); // Handle 404 by returning empty object
        })
        .then(data => {
          document.getElementById('populationSize').value = data.population_size || '';
          document.getElementById('crossoverRate').value = data.crossover_rate || '';
          document.getElementById('mutationRate').value = data.mutation_rate || '';
          document.getElementById('tournamentSize').value = data.tournament_size || '';
          document.getElementById('elitismRate').value = data.elitism_rate || '';
          // Enable the optimize button only after GA params are loaded or defaults are set
          document.querySelector('.btn-optimize').disabled = false;
        })
        .catch(error => {
          console.error('Error fetching GA parameters:', error);
          displayCustomAlert('Failed to load GA parameters: ' + error.message, 'danger');
          document.querySelector('.btn-optimize').disabled = true; // Disable if error
        });
    }

    function resetGaParamsForm() {
      document.getElementById('populationSize').value = '';
      document.getElementById('crossoverRate').value = '';
      document.getElementById('mutationRate').value = '';
      document.getElementById('tournamentSize').value = '';
      document.getElementById('elitismRate').value = '';
    }

    function saveGaParameters() {
      const simulationId = document.getElementById('simulationSelect').value;
      if (!simulationId) {
        displayCustomAlert('Please select a simulation first.', 'warning');
        return;
      }

      const gaParameters = {
        simulation_id: parseInt(simulationId),
        population_size: parseInt(document.getElementById('populationSize').value),
        crossover_rate: parseFloat(document.getElementById('crossoverRate').value),
        mutation_rate: parseFloat(document.getElementById('mutationRate').value),
        tournament_size: parseInt(document.getElementById('tournamentSize').value),
        elitism_rate: parseFloat(document.getElementById('elitismRate').value)
      };

      if (!validateGaParameters(gaParameters)) {
        return; // Validation message already shown by validateGaParameters
      }

      setLoadingButtons(true);

      fetch('http://203.189.121.130:5000/api/save_ga_parameters', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(gaParameters)
      })
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || `HTTP error! status: ${response.status}`); });
          }
          return response.json();
        })
        .then(data => {
          if (data.message) {
            displayCustomAlert(data.message, 'success');
            document.querySelector('.btn-optimize').disabled = false; // Enable optimization after saving params
          } else {
            displayCustomAlert('Error: ' + (data.error || 'Unknown error'), 'danger');
          }
        })
        .catch(error => {
          console.error('Error saving GA parameters:', error);
          displayCustomAlert('An error occurred while saving GA parameters: ' + error.message, 'danger');
        })
        .finally(() => {
          setLoadingButtons(false);
        });
    }

    function validateGaParameters(params) {
      // Basic validation based on backend rules
      if (isNaN(params.population_size) || params.population_size < 10) {
        displayCustomAlert('Population Size must be a number and at least 10.', 'warning');
        return false;
      }
      if (isNaN(params.crossover_rate) || params.crossover_rate < 0 || params.crossover_rate > 1) {
        displayCustomAlert('Crossover Rate must be a number between 0 and 1.', 'warning');
        return false;
      }
      if (isNaN(params.mutation_rate) || params.mutation_rate < 0 || params.mutation_rate > 1) {
        displayCustomAlert('Mutation Rate must be a number between 0 and 1.', 'warning');
        return false;
      }
      if (isNaN(params.tournament_size) || params.tournament_size < 2) {
        displayCustomAlert('Tournament Size must be a number and at least 2.', 'warning');
        return false;
      }
      if (isNaN(params.elitism_rate) || params.elitism_rate < 0 || params.elitism_rate > 0.5) {
        displayCustomAlert('Elitism Rate must be a number between 0 and 0.5.', 'warning');
        return false;
      }
      return true;
    }

    // New validation function for custom tariff inputs
    function validateTariffInputs() {
        const offPeakRate = document.getElementById('offPeakRate').value;
        const onPeakRate = document.getElementById('onPeakRate').value;
        const peakPeriodStartHour = document.getElementById('peakPeriodStartHour').value; // HH:MM string
        const peakPeriodEndHour = document.getElementById('peakPeriodEndHour').value;   // HH:MM string
        const demandChargeInput = document.getElementById('demandChargeInput').value;

        // Check if values are empty and required
        if (offPeakRate === '' || onPeakRate === '' || peakPeriodStartHour === '' || peakPeriodEndHour === '') {
            displayCustomAlert('All custom tariff fields are required.', 'warning');
            return false;
        }

        // Validate numbers
        if (isNaN(parseFloat(offPeakRate)) || parseFloat(offPeakRate) < 0) {
            displayCustomAlert('Off-Peak Rate must be a non-negative number.', 'warning');
            return false;
        }
        if (isNaN(parseFloat(onPeakRate)) || parseFloat(onPeakRate) < 0) {
            displayCustomAlert('On-Peak Rate must be a non-negative number.', 'warning');
            return false;
        }
        
        // Validate time format (HH:MM)
        const timePattern = /^(?:2[0-3]|[01]?[0-9]):[0-5][0-9]$/;
        if (!timePattern.test(peakPeriodStartHour) || !timePattern.test(peakPeriodEndHour)) {
            displayCustomAlert('Peak Period hours must be in HH:MM format (e.g., 17:00).', 'warning');
            return false;
        }

        // Validate demand charge based on tariff type
        const tariffSelect = document.getElementById('tariffSelect');
        if (tariffSelect.value === 'withDemandCharge' && (isNaN(parseFloat(demandChargeInput)) || parseFloat(demandChargeInput) < 0)) {
            displayCustomAlert('Demand Charge must be a non-negative number when "With Demand Charge" is selected.', 'warning');
            return false;
        }
        
        return true;
    }


    // Function to display custom alerts (replace browser's alert)
    function displayCustomAlert(message, type = 'info') {
        // You would typically have a modal or dedicated alert div in your HTML
        // For simplicity, here's a basic implementation that uses an existing div or creates one
        let alertDiv = document.getElementById('customAlert');
        if (!alertDiv) {
            alertDiv = document.createElement('div');
            alertDiv.id = 'customAlert';
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.left = '50%';
            alertDiv.style.transform = 'translateX(-50%)';
            alertDiv.style.zIndex = '1050';
            alertDiv.style.padding = '15px 20px';
            alertDiv.style.borderRadius = '5px';
            alertDiv.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
            alertDiv.style.color = 'white';
            alertDiv.style.textAlign = 'center';
            alertDiv.style.minWidth = '300px';
            alertDiv.style.transition = 'opacity 0.5s ease-in-out';
            document.body.appendChild(alertDiv);
        }

        // Set background color based on type
        switch(type) {
            case 'success':
                alertDiv.style.backgroundColor = '#28a745';
                break;
            case 'danger':
                alertDiv.style.backgroundColor = '#dc3545';
                break;
            case 'warning':
                alertDiv.style.backgroundColor = '#ffc107';
                alertDiv.style.color = '#343a40'; // Dark text for warning
                break;
            case 'info':
            default:
                alertDiv.style.backgroundColor = '#17a2b8';
        }

        alertDiv.textContent = message;
        alertDiv.style.opacity = '1';
        alertDiv.style.display = 'block';

        // Hide after 5 seconds
        setTimeout(() => {
            alertDiv.style.opacity = '0';
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 500); // Wait for transition to finish
        }, 5000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeTabs('waferCream');
      fetchSimulations();
      currentTariff = document.getElementById('tariffSelect').value;
      console.log('Initial tariff:', currentTariff);
      handleSimulationSelect(); // Call this to set initial state of GA form and optimize button
      toggleDemandChargeInput(); // Set initial visibility of demand charge input
    });
  </script>
</body>
</html>
